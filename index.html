<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>卒研 実験モック（同意～選択～送信 全版）</title>
  <style>
    :root { --bg:#fff; --ink:#111; --muted:#666; --line:#e6e6e6; --primary:#2563eb; --danger:#d11a2a; --card:#fff; --shadow:0 2px 10px rgba(0,0,0,.06); --radius:14px; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--ink); font-family:"Noto Sans JP", system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    .bar { position:sticky; top:0; z-index:10; display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line); background:#fff; }
    .bar h1 { margin:0; font-size:16px; font-weight:600; }
    .abort { color:#fff; background:var(--danger); border:none; padding:8px 12px; border-radius:10px; font-size:13px; }
    .wrap { max-width:640px; margin:0 auto; padding:14px 16px 64px; }
    .lead { font-size:14px; color:var(--muted); line-height:1.7; margin-bottom:14px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); margin-bottom:16px; }
    .img { width:100%; aspect-ratio:16/9; background:#f5f5f5; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#999; font-size:13px; margin-bottom:10px; overflow:hidden; }
    .item-title { font-weight:600; margin:0 0 6px; font-size:15px; }
    .desc { color:var(--muted); font-size:13px; margin:0 0 6px; }
    .price { font-size:14px; font-weight:600; margin:0 0 10px; }
    .choose { width:100%; border:none; background:var(--primary); color:#fff; padding:12px; border-radius:12px; font-size:15px; }
    .btn { border:none; background:var(--primary); color:#fff; padding:12px 16px; border-radius:12px; font-size:15px; width:100%; }
    .btn[disabled]{ opacity:.5; }
    .center{ text-align:center; }
    .view{ display:none; }
    .view.active{ display:block; }
    .timer{ font-variant-numeric:tabular-nums; font-size:18px; margin:8px 0 0; }
    .badge { display:inline-block; background:#f0f3ff; color:#1f3bb3; border:1px solid #dfe6ff; border-radius:999px; padding:2px 10px; font-size:12px; }
    .toast { position:fixed; left:16px; right:16px; bottom:16px; background:#111; color:#fff; padding:12px 14px; border-radius:12px; opacity:0; transform:translateY(10px); transition:.25s; font-size:13px; }
    .toast.show { opacity:1; transform:translateY(0); }
    input, select { font-size:15px; }
  </style>
</head>
<body>

  <div class="bar">
    <h1 id="title">同意・説明</h1>
    <button class="abort" onclick="goDebrief()">中止</button>
  </div>

  <main class="wrap">

    <!-- ① 同意・説明 -->
    <section id="consent" class="view">
      <div class="card">
        <div class="badge">同意・説明</div>
        <p class="lead">
          本研究の目的は、<strong>価格提示順序（係留効果）</strong>と<strong>過去の報酬経験（強化履歴）</strong>という
          2つの環境要因が消費者の選択行動に及ぼす影響を比較・検討することです。<br>
          本実験では、7つの商品を画面で順に確認し、<strong>最も購入したいと思うものを1つ選ぶ</strong>タスクを2回行います。<br>
          途中で中止しても構いません。取得データは匿名で扱い、研究以外の目的には使用しません。
        </p>
        <label style="display:block;margin:10px 0;">
          <input type="checkbox" id="agreeChk"> 説明を読み、研究への参加に同意します
        </label>
        <button id="agreeBtn" class="btn" disabled>次へ（基本情報）</button>
      </div>
    </section>

    <!-- ② 基本情報 -->
    <section id="basic" class="view">
      <div class="card">
        <div class="badge">基本情報</div>
        <label class="lead" style="display:block;margin:6px 0 4px;">年齢（半角数字）</label>
        <input id="ageInput" type="number" min="10" max="120" inputmode="numeric"
               style="width:100%;padding:12px;border-radius:12px;border:1px solid var(--line)">
        <label class="lead" style="display:block;margin:12px 0 4px;">性別</label>
        <select id="genderInput" style="width:100%;padding:12px;border-radius:12px;border:1px solid var(--line)">
          <option value="">選択してください</option>
          <option value="male">男性</option>
          <option value="female">女性</option>
          <option value="other">その他/回答しない</option>
        </select>
        <div style="height:12px;"></div>
        <button id="basicBtn" class="btn">次へ（操作説明）</button>
      </div>
    </section>

    <!-- ③ 操作説明 -->
    <section id="instruction" class="view">
      <div class="card">
        <div class="badge">操作説明</div>
        <p class="lead">
          これから7つの商品を<strong>縦スクロール</strong>で確認できます。<br>
          各商品には画像・説明・価格が表示されます。最も購入したいと思う商品を1つ選び、
          <strong>「この商品にする」</strong>ボタンを押してください。<br>
          並び順（高→低 または 低→高）は画面右上に表示されます。<br>
          <em>練習試行はありません。</em>
        </p>
        <button id="startBlock1" class="btn">ブロック①を開始</button>
      </div>
    </section>

    <!-- ④ ブロック①（強化なし） -->
    <section id="selection1" class="view">
      <div class="card">
        <div class="badge">ブロック①（強化なし）</div>
        <p class="lead" id="sel1Lead">
          これから７つの商品を順にご覧ください。<br>
          最も購入したいと思う商品を１つ選んでください。
        </p>
      </div>
      <div id="list1"></div>
    </section>

    <!-- ⑤ 休憩（インターバル） -->
    <section id="rest" class="view">
      <div class="card center">
        <p class="lead" style="margin-bottom:8px;">このあと、次の選択に進みます。</p>
        <p class="lead" style="margin-top:0;">そのままお待ちください。</p>
        <div class="timer"><span id="restCount">3</span> 秒</div>
        <div style="height:10px;"></div>
        <button id="restBtn" class="btn" disabled>進む</button>
      </div>
    </section>

    <!-- ⑥ 強化メッセージ（中価格アイテム） -->
    <section id="reinforcement2" class="view">
      <div class="card">
        <div class="badge">ブロック②（強化あり・メッセージ）</div>
        <p class="lead" id="reinforceText1">あなたは前回、◯◯カテゴリーで</p>
        <p class="lead" id="reinforceText2">
          <strong>「◯◯（中価格）」〔税込◯◯円〕</strong>を購入しました。<br>
          その際の満足度は<strong>8 / 10</strong>でした。
        </p>
        <div class="img" id="reinforceImg">（中価格商品の画像）</div>
        <p class="lead" style="margin:8px 0 0;">続行するにはボタンが有効化されるまでお待ちください（約3秒）</p>
        <div style="height:10px;"></div>
        <button id="reinforceNext" class="btn" disabled>次へ進む</button>
      </div>
    </section>

    <!-- ⑦ ブロック②（強化あり） -->
    <section id="selection2" class="view">
      <div class="card">
        <div class="badge">ブロック②（強化あり）</div>
        <p class="lead" id="sel2Lead">
          これから７つの商品を順にご覧ください。<br>
          最も購入したいと思う商品を１つ選んでください。
        </p>
      </div>
      <div id="list2"></div>
    </section>

    <!-- ⑧ 終了（デブリーフ） -->
    <section id="debrief" class="view">
      <div class="card">
        <h2 style="margin-top:0;">実験終了</h2>
        <p class="lead">
          ご参加ありがとうございました。取得したデータは匿名化して扱います。<br>
          強化メッセージは研究の一部として提示されたもので、実際の購入履歴ではありません。
        </p>
        <p class="lead">
          関西学院大学 文学部 総合心理科学科<br>
          米山研究室所属　新宮 大翔<br>
          連絡先：iss72975@kwansei.ac.jp
        </p>
        <button class="btn" onclick="window.close()">終了する</button>
      </div>
    </section>

  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
  // ====== 設定：GASエンドポイント（/exec） ======
  const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwZcQkeyMwsVfqstBoFtba0_TyOx_bcdze96W1FMjFyO0xLo_mpQR4FHCWgmENBTGbTew/exec";

  // ====== URLパラメータ ======
  const params = new URLSearchParams(location.search);
  const qp = (k, d=null)=> params.get(k) ?? d;
  const condition = {
    pattern: qp('pattern','P1'),
    order: qp('order','high_to_low'),
    block1: qp('block1','rice'),
    block2: qp('block2','pasta'),
    start:  qp('start','auto')
  };

  // 参加者ID
  const participantId = qp('pid', 'P' + Math.random().toString(36).slice(2,6));

  // ====== 商品データ ======
  const DATA = {
    rice: [
      { id:"rice1", name:"しずく光（5kg）",  price:3000, desc:"ふっくら食感で冷めても美味しい。" },
      { id:"rice2", name:"こだちの風（5kg）",price:3500, desc:"ほどよい粘りと香りのバランス。" },
      { id:"rice3", name:"あおば香（5kg）",  price:4000, desc:"上品な甘みで毎日の食卓に。" },
      { id:"rice4", name:"めぐみの粒（5kg）",price:4500, desc:"粒立ち良くバランスの良い旨み。" },
      { id:"rice5", name:"しんまい野（5kg）",price:5000, desc:"炊き上がりはつややかで香り高い。" },
      { id:"rice6", name:"もあさひ穂（5kg）",price:5500, desc:"コクのある味わいで満足感。" },
      { id:"rice7", name:"ひより霞（5kg）",  price:6000, desc:"特別な日にふさわしい上質感。" }
    ],
    pasta: [
      { id:"pasta1", name:"セレナ（500g）",  price:300, desc:"軽やかな食感で毎日に。" },
      { id:"pasta2", name:"ルーチェ（500g）",price:430, desc:"ソースがよく絡む適度なコシ。" },
      { id:"pasta3", name:"トンノ（500g）",  price:560, desc:"やさしい小麦の風味。" },
      { id:"pasta4", name:"フェリーチェ（500g）",price:690, desc:"食感と風味のバランスが良い。" },
      { id:"pasta5", name:"レガート（500g）",price:820, desc:"アルデンテが決まるしなやかさ。" },
      { id:"pasta6", name:"カンツォーネ（500g）",price:950, desc:"小麦の旨味が豊かな余韻。" },
      { id:"pasta7", name:"プリモ（500g）",  price:1080, desc:"特別な日に合うプレミアム感。" }
    ],
    olive: [
      { id:"oil1", name:"ソラーレ（500ml）", price:400,  desc:"軽い口当たりで使いやすい。" },
      { id:"oil2", name:"リモーネ（500ml）", price:700,  desc:"すっきりとした香りが特長。" },
      { id:"oil3", name:"マーレ（500ml）",   price:1000, desc:"毎日の料理に合わせやすい。" },
      { id:"oil4", name:"フィオーレ（500ml）", price:1300, desc:"香りとコクのバランスが良い。" },
      { id:"oil5", name:"ルーナ（500ml）",    price:1600, desc:"深みのある味わいで満足感。" },
      { id:"oil6", name:"ヴィータ（500ml）",  price:1900, desc:"サラダにも合う上質な風味。" },
      { id:"oil7", name:"ステッラ（500ml）",  price:2200, desc:"香り高く特別な一皿に。" }
    ]
  };

  // ====== ユーティリティ ======
  const $ = s => document.querySelector(s);
  const show = id => { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); $(id).classList.add('active'); };
  const fmt = n => n.toLocaleString('ja-JP');
  const jpCat = c => c==='rice'?'米':c==='pasta'?'パスタ':'オリーブオイル';
  const getMiddleItem = cat => DATA[cat].slice().sort((a,b)=>a.price-b.price)[3];
  function goDebrief(){ show('#debrief'); }
  function toast(msg){ const el = $('#toast'); el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 1800); }

  // 測定
  let tStart = 0, scrollStart = 0;
  function startMeasure(){ tStart = performance.now(); scrollStart = window.scrollY; }
  function stopMeasure(){ return { rt: Math.round(performance.now()-tStart), scrollAmount: Math.max(0, window.scrollY - scrollStart) }; }

  // リスト描画
  function renderList(containerId, cat, order, onChoose){
    const listEl = $(containerId);
    listEl.innerHTML = '';
    const items = [...DATA[cat]].sort((a,b)=> order==='high_to_low' ? b.price-a.price : a.price-b.price);
    items.forEach(item=>{
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div class="img">（画像：${item.name}）</div>
        <p class="item-title">${item.name}</p>
        <p class="desc">${item.desc}</p>
        <p class="price">価格：${fmt(item.price)}円</p>
        <button class="choose">この商品にする</button>`;
      card.querySelector('.choose').addEventListener('click', ()=> onChoose(item));
      listEl.appendChild(card);
    });
  }

  // ====== 送信（CORS 正式対応） ======
  async function sendLog(payload){
  // text/plain の Blob にすると “シンプルリクエスト” 扱いでプリフライトが出ません
  const body = new Blob([JSON.stringify(payload)], { type: 'text/plain' });

  try {
    // ページ遷移中でも確実に飛ばせるように、使える環境では sendBeacon を優先
    if (navigator.sendBeacon) {
      const ok = navigator.sendBeacon(GAS_ENDPOINT, body);
      if (ok) { toast('データ送信しました'); return; }
      // 失敗時は fetch フォールバック
    }
    await fetch(GAS_ENDPOINT, {
      method: 'POST',
      mode: 'no-cors',     // ← プリフライト回避のキモ
      body                 // ← Content-Type ヘッダは付けない（自動で text/plain になる）
      // ヘッダは一切付けないこと！（付けるとプリフライトが発生）
    });
    toast('データ送信しました');
  } catch (e) {
    console.error(e);
    toast('送信エラー');
  }
}


  async function sendRow(row) {
    const payload = Object.assign({
      participant_id: participantId,
      consent: '',
      age: '',
      gender: '',
      pattern: condition.pattern,
      order_condition: condition.order,
      block: '',
      category: '',
      selected_item_id: '',
      selected_item_name: '',
      selected_item_price: '',
      reaction_time_ms: '',
      scroll_amount_px: '',
      timestamp: new Date().toISOString()
    }, row);
    await sendLog(payload);
  }

  // ====== 画面イベント ======
  (function setupConsent(){
    const chk = $('#agreeChk'), btn = $('#agreeBtn');
    chk.addEventListener('change', ()=> btn.disabled = !chk.checked);
    btn.addEventListener('click', async ()=>{
      await sendRow({ consent:'consent' });
      $('#title').textContent = '基本情報';
      show('#basic');
    });
  })();

  (function setupBasic(){
    $('#basicBtn').addEventListener('click', async ()=>{
      const age = $('#ageInput').value.trim();
      const gender = $('#genderInput').value;
      if (!age || !/^\d+$/.test(age)) { toast('年齢を半角数字で入力してください'); return; }
      if (!gender) { toast('性別を選択してください'); return; }
      await sendRow({ consent:'basic_info', age:String(parseInt(age,10)), gender });
      $('#title').textContent = '操作説明';
      show('#instruction');
    });
  })();

  (function setupInstruction(){
    $('#startBlock1').addEventListener('click', ()=>{
      doSelection1();
    });
  })();

  function doSelection1(){
    $('#title').textContent = '商品選択（ブロック①）';
    $('#sel1Lead').innerHTML =
      `これから７つの商品を順にご覧ください。<br>最も購入したいと思う商品を１つ選んでください。<br>
       <span class="lead">カテゴリ：${jpCat(condition.block1)}　並び：${condition.order==='high_to_low'?'高→低':'低→高'}</span>`;
    show('#selection1');
    renderList('#list1', condition.block1, condition.order, async (item)=>{
      const { rt, scrollAmount } = stopMeasure();
      await sendRow({
        block:'block1_selection',
        category: condition.block1,
        selected_item_id: item.id,
        selected_item_name: item.name,
        selected_item_price: item.price,
        reaction_time_ms: rt,
        scroll_amount_px: scrollAmount
      });
      startRest(()=> doReinforcement2());
    });
    startMeasure();
  }

  function startRest(next){
    $('#title').textContent = '休憩';
    show('#rest');
    let n=3; $('#restCount').textContent = n;
    const btn = $('#restBtn'); btn.disabled = true;
    const iv = setInterval(()=>{
      n--; $('#restCount').textContent = n;
      if (n<=0){ clearInterval(iv); btn.disabled = false; }
    }, 1000);
    btn.onclick = ()=> next && next();
  }

  function doReinforcement2(){
    $('#title').textContent = '前回の購入履歴';
    const middle = getMiddleItem(condition.block2);
    $('#reinforceText1').textContent = `あなたは前回、${jpCat(condition.block2)}カテゴリーで`;
    $('#reinforceText2').innerHTML =
      `<strong>「${middle.name}」〔税込${fmt(middle.price)}円〕</strong>を購入しました。<br>
       その際の満足度は<strong>8 / 10</strong>でした。`;
    $('#reinforceImg').textContent = `（${middle.name} の画像）`;
    show('#reinforcement2');
    const btn = $('#reinforceNext'); btn.disabled = true;
    setTimeout(()=> btn.disabled = false, 3000);
    btn.onclick = ()=> doSelection2();
  }

  function doSelection2(){
    $('#title').textContent = '商品選択（ブロック②）';
    $('#sel2Lead').innerHTML =
      `これから７つの商品を順にご覧ください。<br>最も購入したいと思う商品を１つ選んでください。<br>
       <span class="lead">カテゴリ：${jpCat(condition.block2)}　並び：${condition.order==='high_to_low'?'高→低':'低→高'}</span>`;
    show('#selection2');
    renderList('#list2', condition.block2, condition.order, async (item)=>{
      const { rt, scrollAmount } = stopMeasure();
      await sendRow({
        block:'block2_selection',
        category: condition.block2,
        selected_item_id: item.id,
        selected_item_name: item.name,
        selected_item_price: item.price,
        reaction_time_ms: rt,
        scroll_amount_px: scrollAmount
      });
      show('#debrief');
    });
    startMeasure();
  }

  (function init(){
    const s = condition.start;
    if (s==='consent') { show('#consent'); return; }
    if (s==='basic') { show('#basic'); return; }
    if (s==='instruction') { show('#instruction'); return; }
    if (s==='selection1') { doSelection1(); return; }
    if (s==='rest') { startRest(()=>doReinforcement2()); return; }
    if (s==='reinforcement2') { doReinforcement2(); return; }
    if (s==='selection2') { doSelection2(); return; }
    show('#consent');
  })();
</script>
</body>
</html>




